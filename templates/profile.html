<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ business.name }} — Comuni IA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet"/>
</head>
<body data-business-id="{{ business.id }}" data-is-owner="{{ 'true' if is_owner else 'false' }}" data-latitude="{{ business.latitude or '' }}" data-longitude="{{ business.longitude or '' }}">

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('home') }}">
      <i class="bi bi-chat-dots text-primary me-2"></i>Comuni IA
    </a>
    <div class="collapse navbar-collapse" id="navbarNavProfile">
      <ul class="navbar-nav ms-auto align-items-lg-center">
        <li class="nav-item"><a href="{{ url_for('home') }}" class="nav-link">Inicio</a></li>
        {% if session.user_id %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-1"></i> Perfil
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('logout') }}">Cerrar Sesión</a></li>
          </ul>
        </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- BANNER -->
<div class="profile-banner" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>

<!-- CONTENIDO -->
<div class="container pb-5">
  <div class="profile-header">
    <div class="row">
      <div class="col-md-3 text-center mb-3 position-relative">
        {% if business.logo %}
        <img src="{{ url_for('static', filename='uploads/' + business.logo) }}" class="profile-avatar shadow-lg mx-auto">
        {% else %}
        <div class="profile-avatar shadow-lg mx-auto d-flex align-items-center justify-content-center bg-light">
          <i class="bi bi-shop display-4 text-muted"></i>
        </div>
        {% endif %}
        {% if is_owner %}
        <button class="btn btn-sm btn-light position-absolute bottom-0 start-50 translate-middle-x mb-2" data-bs-toggle="modal" data-bs-target="#updateLogoModal" style="opacity: 0.8;">
          <i class="bi bi-camera"></i> Cambiar
        </button>
        {% endif %}
      </div>
      <div class="col-md-9">
        <div class="bg-white rounded-4 shadow-sm p-4 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h1 class="h3 fw-bold mb-2">{{ business.name }}</h1>
            </div>
            {% if session.user_id and not is_owner %}
            <button id="favoriteBtn" class="btn btn-lg btn-outline-danger border-0">
              <i class="bi {{ 'bi-heart-fill' if is_favorited else 'bi-heart' }}"></i>
            </button>
            {% elif is_owner %}
            <div>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editBusinessModal">
                <i class="bi bi-pencil-square"></i> Editar
              </button>
            </div>
            {% endif %}
          </div>
          <p class="text-muted mb-2"><i class="bi bi-grid me-2"></i>{{ business.category }}</p>
          <p class="mb-3">{{ business.description }}</p>
          <div class="d-flex gap-2 flex-wrap mb-3">
            <span class="badge bg-light text-dark border"><i class="bi bi-geo-alt text-primary me-1"></i> {{ business.location }}</span>
            <span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> {{ avg_rating if avg_rating > 0 else 'Nuevo' }}</span>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            {% if business.whatsapp %}
            <a href="https://wa.me/{{ business.whatsapp }}" target="_blank" class="btn btn-success btn-sm">
              <i class="bi bi-whatsapp"></i> WhatsApp
            </a>
            {% endif %}
            {% if business.phone %}
            <a href="tel:{{ business.phone }}" class="btn btn-primary btn-sm">
              <i class="bi bi-telephone"></i> {{ business.phone }}
            </a>
            {% endif %}
            {% if business.email %}
            <a href="mailto:{{ business.email }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-envelope"></i> Email
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="row g-3 my-4">
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-eye display-6 text-primary"></i>
        <h4 class="mt-2 mb-0">{{ view_count }}</h4>
        <small class="text-muted">Visitas</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-bag display-6 text-success"></i>
        <h4 class="mt-2 mb-0">{{ products|length }}</h4>
        <small class="text-muted">Productos</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-star-fill display-6 text-warning"></i>
        <h4 class="mt-2 mb-0">{{ avg_rating if avg_rating > 0 else 'N/A' }}</h4>
        <small class="text-muted">Rating</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-chat-dots display-6 text-info"></i>
        <h4 class="mt-2 mb-0">{{ reviews|length }}</h4>
        <small class="text-muted">Reseñas</small>
      </div>
    </div>
  </div>

  <!-- PRODUCTOS -->
  <section class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="section-title mb-0">Productos</h2>
      {% if is_owner %}
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-circle"></i> Agregar
      </button>
      {% endif %}
    </div>
    
    <div id="products-list" class="row g-3">
      {% if products %}
        {% for product in products %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
          <div class="product-card-new" data-product-id="{{ product.id }}">
            <div class="product-card-inner">
              <!-- Frente de la tarjeta -->
              <div class="product-card-front">
                {% if product.image_url %}
                <img src="{{ url_for('static', filename='uploads/' + product.image_url) }}" class="product-img-new">
                {% else %}
                <div class="product-img-new bg-light d-flex align-items-center justify-content-center">
                  <i class="bi bi-image display-4 text-muted"></i>
                </div>
                {% endif %}
                <div class="p-3">
                  <h6 class="fw-bold mb-2">{{ product.name }}</h6>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="h6 text-primary mb-0">Bs. {{ "%.2f"|format(product.price) }}</span>
                    <button class="btn btn-sm btn-outline-primary flip-button">
                      <i class="bi bi-arrow-clockwise"></i> Ver Detalles
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Reverso de la tarjeta -->
              <div class="product-card-back">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="fw-bold mb-0">{{ product.name }}</h6>
                  <button class="btn btn-sm btn-outline-secondary flip-button">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                </div>
                <div class="product-description small">
                  {% if product.description %}
                  <p class="mb-3">{{ product.description }}</p>
                  {% else %}
                  <p class="text-muted">Sin descripción disponible</p>
                  {% endif %}
                </div>
                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="h6 text-primary mb-0">Bs. {{ "%.2f"|format(product.price) }}</span>
                    {% if is_owner %}
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-primary edit-product" data-bs-toggle="modal" data-bs-target="#editProductModal" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-description="{{ product.description or '' }}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger delete-product" data-id="{{ product.id }}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="col-12 text-center py-5">
        <i class="bi bi-bag-x display-1 text-muted"></i>
        <h5 class="mt-3">No hay productos</h5>
        <p class="text-muted">{% if is_owner %}Agrega tu primer producto{% else %}Este negocio no tiene productos aún{% endif %}</p>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- MAPA Y RESEÑAS -->
  <section class="mt-5">
    <div class="row g-4">
      <!-- Columna de Mapa -->
      <div class="col-lg-5">
        <h2 class="section-title">Ubicación</h2>
        <div id="profileMap" class="map-container shadow-sm"></div>
        {% if not business.latitude or not business.longitude %}
        <p class="text-muted mt-2 small">El dueño aún no ha especificado una ubicación exacta en el mapa.</p>
        {% endif %}
      </div>

      <!-- Columna de Reseñas -->
      <div class="col-lg-7">
        <h2 class="section-title">Reseñas</h2>

        <!-- Formulario para dejar reseña (solo para clientes logueados) -->
        {% if session.user_id and not is_owner %}
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4">
            <h5 class="card-title">Deja tu opinión</h5>
            <form id="reviewForm">
              <div class="mb-3">
                <label class="form-label">Calificación</label>
                <div id="ratingStars" class="text-warning" style="cursor: pointer; font-size: 1.5rem;">
                  <i class="bi bi-star" data-value="1"></i>
                  <i class="bi bi-star" data-value="2"></i>
                  <i class="bi bi-star" data-value="3"></i>
                  <i class="bi bi-star" data-value="4"></i>
                  <i class="bi bi-star" data-value="5"></i>
                </div>
                <input type="hidden" name="rating" id="ratingInput" required>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">Comentario</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Enviar Reseña</button>
            </form>
          </div>
        </div>
        {% elif not session.user_id %}
        <div class="alert alert-info">
          <a href="{{ url_for('login', next=request.url) }}">Inicia sesión</a> o 
          <a href="{{ url_for('register_client') }}">regístrate como cliente</a> para dejar una reseña.
        </div>
        {% endif %}

        <!-- Lista de Reseñas -->
        <div id="reviews-list">
          {% if reviews %}
            {% for review in reviews %}
            <div class="review-box shadow-sm mb-3">
              <div class="d-flex justify-content-between mb-2">
                <h6 class="fw-bold mb-0"><i class="bi bi-person-circle text-primary me-2"></i>{{ review.author }}</h6>
                <small class="text-muted">{{ review.created_at }}</small>
              </div>
              <div class="text-warning mb-2">
                {% for i in range(review.rating) %}<i class="bi bi-star-fill"></i>{% endfor %}
                {% for i in range(5 - review.rating) %}<i class="bi bi-star"></i>{% endfor %}
              </div>
              <p class="text-muted mb-0">{{ review.comment }}</p>
            </div>
            {% endfor %}
          {% else %}
          <div class="col-12 text-center py-5">
            <i class="bi bi-star display-1 text-muted"></i>
            <h5 class="mt-3">Sin reseñas</h5>
            <p class="text-muted">Sé el primero en dejar una reseña.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
</div>

<!-- MODAL EDITAR PRODUCTO -->
{% if is_owner %}
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Editar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="editProductForm">
          <input type="hidden" name="product_id" id="editProductId">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre</label>
            <input type="text" class="form-control" name="name" id="editProductName" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Descripción</label>
            <textarea class="form-control" name="description" id="editProductDescription" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Precio (Bs.)</label>
            <input type="number" class="form-control" name="price" id="editProductPrice" step="0.01" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Nueva Imagen (opcional)</label>
            <input type="file" class="form-control" name="image" accept="image/*">
          </div>
          <button type="submit" class="btn btn-primary w-100">Guardar Cambios</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL AGREGAR PRODUCTO -->
{% if is_owner %}
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Agregar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addProductForm">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Precio (Bs.)</label>
            <input type="number" class="form-control" name="price" step="0.01" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Imagen</label>
            <input type="file" class="form-control" name="image" accept="image/*">
          </div>
          <button type="submit" class="btn btn-primary w-100">Agregar</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL ACTUALIZAR LOGO -->
{% if is_owner %}
<div class="modal fade" id="updateLogoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Actualizar Logo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="updateLogoForm" method="POST" action="{{ url_for('update_logo', id=business.id) }}" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label fw-bold">Selecciona la nueva imagen</label>
            <input type="file" class="form-control" name="logo" accept="image/*" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Actualizar Logo</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL EDITAR NEGOCIO -->
{% if is_owner %}
<div class="modal fade" id="editBusinessModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Editar Información del Negocio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form method="POST" action="{{ url_for('edit_business', id=business.id) }}">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre del Negocio</label>
            <input type="text" class="form-control" name="name" value="{{ business.name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Descripción</label>
            <textarea class="form-control" name="description" rows="5" required>{{ business.description }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Categoría</label>
            <select name="category" class="form-select" required>
              {% set categories = ["Gastronomía", "Moda y Ropa", "Servicios Profesionales", "Belleza y Cuidado Personal", "Hogar y Decoración", "Tecnología", "Salud y Bienestar", "Educación", "Otros"] %}
              {% for cat in categories %}
              <option value="{{ cat }}" {% if business.category == cat %}selected{% endif %}>{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
          <hr class="my-4">
          <h6 class="mb-3">Información de Contacto (Opcional)</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold"><i class="bi bi-telephone"></i> Teléfono</label>
              <input type="tel" class="form-control" name="phone" value="{{ business.phone or '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold"><i class="bi bi-whatsapp text-success"></i> WhatsApp</label>
              <input type="tel" class="form-control" name="whatsapp" value="{{ business.whatsapp or '' }}" placeholder="591xxxxxxxx">
            </div>
            <div class="col-md-12">
              <label class="form-label fw-bold"><i class="bi bi-envelope"></i> Email del Negocio</label>
              <input type="email" class="form-control" name="business_email" value="{{ business.email or '' }}">
            </div>
          </div>
          <hr class="my-4">
          <h6 class="mb-3">Ubicación en el Mapa</h6>
          <p class="text-muted small">Haz clic en el mapa para colocar o mover el marcador en la ubicación exacta de tu negocio.</p>
          <div id="editMap" style="height: 300px; border-radius: 12px; z-index: 1056;"></div>
          <input type="hidden" id="latitude" name="latitude" value="{{ business.latitude or '' }}">
          <input type="hidden" id="longitude" name="longitude" value="{{ business.longitude or '' }}">
          <button type="button" id="clearLocationBtn" class="btn btn-sm btn-outline-danger mt-2">
            <i class="bi bi-x-circle"></i> Limpiar Ubicación
          </button>

          <button type="submit" class="btn btn-primary w-100 mt-4">Guardar Cambios</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const businessId = document.body.dataset.businessId;
  const isOwner = document.body.dataset.isOwner === 'true';

  // Manejador del efecto flip
  document.querySelectorAll('.flip-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const card = e.target.closest('.product-card-new');
      card.classList.toggle('flipped');
    });
  });

  // Solo inicializamos el formulario y el modal si el usuario es propietario
  if (isOwner) {
    const form = document.getElementById('addProductForm');
    const modalEl = document.getElementById('addProductModal');
    const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const resp = await fetch(`/api/products/${businessId}`, {
          method: 'POST',
          body: formData
        });
        const data = await resp.json();
        if (data.success) {
          form.reset();
          modal?.hide();
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'No se pudo agregar'));
        }
      } catch (err) {
        alert('Error de conexión');
      }
    });
  }

  // --- LÓGICA DE FAVORITOS ---
  const favoriteBtn = document.getElementById('favoriteBtn');
  if (favoriteBtn) {
    favoriteBtn.addEventListener('click', async () => {
      try {
        const resp = await fetch(`/api/business/${businessId}/favorite`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await resp.json();
        if (result.success) {
          const icon = favoriteBtn.querySelector('i');
          if (result.favorited) {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
          } else {
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
          }
        }
      } catch (err) {
        alert('Error de conexión. No se pudo cambiar el estado de favorito.');
      }
    });
  }

  // Manejadores de edición de producto
  document.querySelectorAll('.edit-product').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const data = e.target.closest('.edit-product').dataset;
      document.getElementById('editProductId').value = data.id;
      document.getElementById('editProductName').value = data.name;
      document.getElementById('editProductDescription').value = data.description;
      document.getElementById('editProductPrice').value = data.price;
    });
  });

  const editProductForm = document.getElementById('editProductForm');
  editProductForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const productId = formData.get('product_id');

    try {
      const resp = await fetch(`/api/products/${productId}`, {
        method: 'PUT',
        body: formData
      });
      const data = await resp.json();
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
        modal.hide();
        location.reload();
      } else {
        alert('Error: ' + (data.error || 'No se pudo actualizar el producto'));
      }
    } catch (err) {
      alert('Error de conexión');
    }
  });

  async function deleteProduct(btn) {
    const id = btn.closest('.delete-product').dataset.id;
    if (!confirm('¿Eliminar este producto?')) return;

    try {
      const resp = await fetch(`/api/products/${id}`, { method: 'DELETE' });
      const data = await resp.json();
      if (data.success) {
        btn.closest('.col-lg-3, .col-md-4, .col-6').remove();
        if (document.getElementById('products-list').children.length === 0) {
          location.reload();
        }
      } else {
        alert('Error: ' + (data.error || 'No se pudo eliminar'));
      }
    } catch (err) {
      alert('Error de conexión');
    }
  }

  // --- MAPA LEAFLET ---
  const lat = document.body.dataset.latitude ? parseFloat(document.body.dataset.latitude) : null;
  const lon = document.body.dataset.longitude ? parseFloat(document.body.dataset.longitude) : null;
  const defaultLat = -17.7833; // Santa Cruz
  const defaultLon = -63.1833;

  const profileMapDiv = document.getElementById('profileMap');
  if (profileMapDiv) {
    const map = L.map('profileMap');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    if (lat && lon) {
      map.setView([lat, lon], 16);
      L.marker([lat, lon]).addTo(map).bindPopup('<b>{{ business.name }}</b><br>Ubicación exacta.').openPopup();
    } else {
      map.setView([defaultLat, defaultLon], 12);
    }
  }

  // Mapa en el modal de edición (interactivo)
  const editBusinessModal = document.getElementById('editBusinessModal');
  editBusinessModal?.addEventListener('shown.bs.modal', () => {
    const editMap = L.map('editMap').setView([lat || defaultLat, lon || defaultLon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap);

    let marker;
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');

    if (lat && lon) {
      marker = L.marker([lat, lon], { draggable: true }).addTo(editMap);
    }

    editMap.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng, { draggable: true }).addTo(editMap);
      }
      latInput.value = lat;
      lonInput.value = lng;

      marker.on('dragend', (event) => {
        const position = marker.getLatLng();
        latInput.value = position.lat;
        lonInput.value = position.lng;
      });
    });

    if (marker) {
      marker.on('dragend', (event) => {
        const position = marker.getLatLng();
        latInput.value = position.lat;
        lonInput.value = position.lng;
      });
    }

    document.getElementById('clearLocationBtn').addEventListener('click', () => {
      if (marker) editMap.removeLayer(marker);
      latInput.value = '';
      lonInput.value = '';
    });
  });
  // --- LÓGICA DE RESEÑAS ---
  const reviewForm = document.getElementById('reviewForm');
  if (reviewForm) {
    const ratingStars = document.getElementById('ratingStars');
    const ratingInput = document.getElementById('ratingInput');

    ratingStars.addEventListener('click', (e) => {
      if (e.target.tagName === 'I') {
        const rating = e.target.dataset.value;
        ratingInput.value = rating;
        // Actualizar visualmente las estrellas
        Array.from(ratingStars.children).forEach(star => {
          if (star.dataset.value <= rating) {
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill');
          } else {
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
          }
        });
      }
    });

    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(reviewForm);
      const data = Object.fromEntries(formData.entries());

      try {
        const resp = await fetch(`/api/reviews/${businessId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await resp.json();
        if (result.success) {
          location.reload(); // Recargar solo si la reseña se envió con éxito
        } else {
          alert('Error: ' + (result.error || 'No se pudo enviar la reseña.'));
        }
      } catch (err) {
        alert('Error de conexión al enviar la reseña.');
      }
    });
  }
</script>
</body>
</html>
