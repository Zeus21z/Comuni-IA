{% extends "layout.html" %}

{% block title %}{{ business.name }} — Comuni IA{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
{% endblock %}

{% block content %}
<div data-business-id="{{ business.id }}" data-is-owner="{{ 'true' if is_owner else 'false' }}" data-latitude="{{ business.latitude or '' }}" data-longitude="{{ business.longitude or '' }}">

<!-- BANNER -->
<div class="profile-banner" style="background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>

<!-- CONTENIDO -->
<div class="container pb-5">
  <div class="profile-header">
    <div class="row">
      <div class="col-md-3 text-center mb-3 position-relative">
        {% if business.logo %}
        <img src="{{ url_for('static', filename='uploads/' + business.logo) }}" class="profile-avatar shadow-lg mx-auto">
        {% else %}
        <div class="profile-avatar shadow-lg mx-auto d-flex align-items-center justify-content-center bg-light">
          <i class="bi bi-shop display-4 text-muted"></i>
        </div>
        {% endif %}
        {% if is_owner %}
        <button class="btn btn-sm btn-light position-absolute bottom-0 start-50 translate-middle-x mb-2" data-bs-toggle="modal" data-bs-target="#updateLogoModal" style="opacity: 0.8;">
          <i class="bi bi-camera"></i> Cambiar
        </button>
        {% endif %}
      </div>
      <div class="col-md-9">
        <div class="bg-white rounded-4 shadow-sm p-4 h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h1 class="h3 fw-bold mb-2">{{ business.name }}</h1>
            </div>
            {% if session.user_id and not is_owner %}
            <button id="favoriteBtn" class="btn btn-lg btn-outline-danger border-0">
              <i class="bi {{ 'bi-heart-fill text-danger' if is_favorited else 'bi-heart' }}"></i>
            </button>
            {% elif is_owner %}
            <div>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editBusinessModal">
                <i class="bi bi-pencil-square"></i> Editar
              </button>
            </div>
            {% endif %}
          </div>
          <p class="text-muted mb-2"><i class="bi bi-grid me-2"></i>{{ business.category }}</p>
          <p class="mb-3">{{ business.description }}</p>
          <div class="d-flex gap-2 flex-wrap mb-3">
            <span class="badge bg-light text-dark border"><i class="bi bi-geo-alt text-primary me-1"></i> {{ business.location }}</span>
            <span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> {{ avg_rating if avg_rating > 0 else 'Nuevo' }}</span>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            {% if business.whatsapp %}
            <a href="https://wa.me/{{ business.whatsapp }}" target="_blank" class="btn btn-success btn-sm">
              <i class="bi bi-whatsapp"></i> WhatsApp
            </a>
            {% endif %}
            {% if business.phone %}
            <a href="tel:{{ business.phone }}" class="btn btn-primary btn-sm">
              <i class="bi bi-telephone"></i> {{ business.phone }}
            </a>
            {% endif %}
            {% if business.email %}
            <a href="mailto:{{ business.email }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-envelope"></i> Email
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STATS -->
  <div class="row g-3 my-4">
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-eye display-6 text-primary"></i>
        <h4 class="mt-2 mb-0">{{ view_count }}</h4>
        <small class="text-muted">Visitas</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-bag display-6 text-success"></i>
        <h4 class="mt-2 mb-0">{{ products|length }}</h4>
        <small class="text-muted">Productos</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-star-fill display-6 text-warning"></i>
        <h4 class="mt-2 mb-0">{{ avg_rating if avg_rating > 0 else 'N/A' }}</h4>
        <small class="text-muted">Rating</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="stats-box shadow-sm">
        <i class="bi bi-chat-dots display-6 text-info"></i>
        <h4 class="mt-2 mb-0">{{ reviews|length }}</h4>
        <small class="text-muted">Reseñas</small>
      </div>
    </div>
  </div>

  <!-- SECCIÓN DE RESERVAS (SOLO PARA DUEÑOS) -->
  {% if is_owner and reservations %}
  <section class="mb-5">
    <h2 class="section-title">Reservas Pendientes</h2>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Producto</th>
            <th>Cliente</th>
            <th>Cantidad</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reservations %}
          <tr data-reservation-id="{{ r.id }}">
            <td>{{ r.product.name }}</td>
            <td>{{ r.user.email }}</td>
            <td>{{ r.quantity }}</td>
            <td>{{ r.created_at.strftime('%d/%m/%y %H:%M') }}</td>
            <td>
              <span class="badge 
                {% if r.status == 'pendiente' %}bg-warning text-dark
                {% elif r.status == 'confirmada' %}bg-success
                {% elif r.status == 'rechazada' %}bg-danger
                {% else %}bg-secondary
                {% endif %}">{{ r.status|capitalize }}</span>
            </td>
            <td>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-success update-status" data-status="confirmada" title="Confirmar"><i class="bi bi-check-lg"></i></button>
                <button class="btn btn-sm btn-outline-danger update-status" data-status="rechazada" title="Rechazar"><i class="bi bi-x-lg"></i></button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

  <!-- PRODUCTOS -->
  <section class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="section-title mb-0">Productos</h2>
      {% if is_owner %}
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-circle"></i> Agregar
      </button>
      {% endif %}
    </div>
    
    <div id="products-list" class="row g-3">
      {% if products %}
        {% for product in products %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-12">
          <div class="product-card-new" data-product-id="{{ product.id }}">
            <div class="product-card-inner">
              <!-- Frente de la tarjeta -->
              <div class="product-card-front">
                <!-- NUEVO: Capa superpuesta para "Click para detalles" -->
                <div class="product-card-overlay">
                  <span class="overlay-text"><i class="bi bi-info-circle-fill me-2"></i>Click para ver detalles</span>
                </div>

                {% if product.image_url %}
                <img src="{{ url_for('static', filename='uploads/' + product.image_url) }}" class="product-img-new">
                {% else %}
                <div class="product-img-new bg-light d-flex align-items-center justify-content-center">
                  <i class="bi bi-image display-4 text-muted"></i>
                </div>
                {% endif %}
                <div class="p-3">
                  <h6 class="fw-bold mb-2">{{ product.name }}</h6>
                  <div class="mb-2">
                    <span class="badge {{ 'bg-success-soft text-success' if product.stock > 0 else 'bg-danger-soft text-danger' }}">
                      {{ 'Disponibles: ' + product.stock|string if product.stock > 0 else 'Agotado' }}
                    </span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="h6 text-primary mb-0">Bs. {{ "%.2f"|format(product.price) }}</span>
                    {% if session.user_id and not is_owner %}
                      <button class="btn btn-sm btn-primary reserve-product" data-id="{{ product.id }}" data-name="{{ product.name }}" data-stock="{{ product.stock }}" data-bs-toggle="modal" data-bs-target="#reserveProductModal" {% if product.stock <= 0 %}disabled{% endif %}>
                        <i class="bi bi-calendar-check"></i> Reservar
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Reverso de la tarjeta -->
              <div class="product-card-back">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h6 class="fw-bold mb-0">{{ product.name }}</h6>
                  <button class="btn btn-sm btn-outline-secondary flip-back-button" title="Volver">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                </div>
                <div class="product-description small">
                  {% if product.description %}
                  <p class="mb-3">{{ product.description }}</p>
                  {% else %}
                  <p class="text-muted">Sin descripción disponible</p>
                  {% endif %}
                </div>
                <div class="mb-3">
                  <span class="badge {{ 'bg-success-soft text-success' if product.stock > 0 else 'bg-danger-soft text-danger' }}">
                    {{ 'Disponibles: ' + product.stock|string if product.stock > 0 else 'Agotado' }}
                  </span>
                </div>
                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="h6 text-primary mb-0">Bs. {{ "%.2f"|format(product.price) }}</span>
                    {% if is_owner %}
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-primary edit-product" data-bs-toggle="modal" data-bs-target="#editProductModal" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}" data-description="{{ product.description or '' }}" data-stock="{{ product.stock }}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger delete-product" data-id="{{ product.id }}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="col-12 text-center py-5">
        <div class="empty-state-card">
            <i class="bi bi-bag-x display-1 text-muted"></i>
            <h5 class="mt-3">No hay productos registrados</h5>
            <p class="text-muted">{% if is_owner %}¡Es tu oportunidad! Muestra lo que vendes.{% else %}Este negocio aún no ha publicado sus productos.{% endif %}</p>
        </div>
    </div>
      {% endif %}
    </div>
  </section>

  <!-- MAPA Y RESEÑAS -->
  <section class="mt-5">
    <div class="row g-4">
      <!-- Columna de Mapa -->
      <div class="col-lg-5">
        <h2 class="section-title">Ubicación</h2>
        <div id="profileMap" class="map-container shadow-sm"></div>
        {% if not business.latitude or not business.longitude %}
        <p class="text-muted mt-2 small">El dueño aún no ha especificado una ubicación exacta en el mapa.</p>
        {% endif %}
      </div>

      <!-- Columna de Reseñas -->
      <div class="col-lg-7">
        <h2 class="section-title">Reseñas</h2>

        <!-- Formulario para dejar reseña (solo para clientes logueados) -->
        {% if session.user_id and not is_owner %}
        <div class="card shadow-sm mb-4">
          <div class="card-body p-4">
            <h5 class="card-title">Deja tu opinión</h5>
            <form id="reviewForm">
              <div class="mb-3">
                <label class="form-label">Calificación</label>
                <div id="ratingStars" class="text-warning" style="cursor: pointer; font-size: 1.5rem;">
                  <i class="bi bi-star" data-value="1"></i>
                  <i class="bi bi-star" data-value="2"></i>
                  <i class="bi bi-star" data-value="3"></i>
                  <i class="bi bi-star" data-value="4"></i>
                  <i class="bi bi-star" data-value="5"></i>
                </div>
                <input type="hidden" name="rating" id="ratingInput" required>
              </div>
              <div class="mb-3">
                <label for="comment" class="form-label">Comentario</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Enviar Reseña</button>
            </form>
          </div>
        </div>
        {% elif not session.user_id %}
        <div class="alert alert-info">
          <a href="{{ url_for('login', next=request.url) }}">Inicia sesión</a> o 
          <a href="{{ url_for('register_client') }}">regístrate como cliente</a> para dejar una reseña.
        </div>
        {% endif %}

        <!-- Lista de Reseñas -->
        <div id="reviews-list">
          {% if reviews %}
            {% for review in reviews %}
            <div class="review-box shadow-sm mb-3">
              <div class="d-flex justify-content-between mb-2">
                <h6 class="fw-bold mb-0"><i class="bi bi-person-circle text-primary me-2"></i>{{ review.author }}</h6>
                <small class="text-muted">{{ review.created_at }}</small>
              </div>
              <div class="text-warning mb-2">
                {% for i in range(review.rating) %}<i class="bi bi-star-fill"></i>{% endfor %}
                {% for i in range(5 - review.rating) %}<i class="bi bi-star"></i>{% endfor %}
              </div>
              <p class="text-muted mb-0">{{ review.comment }}</p>
            </div>
            {% endfor %}
          {% else %}
          <div class="col-12 text-center py-5">
            <i class="bi bi-star display-1 text-muted"></i>
            <h5 class="mt-3">Sin reseñas</h5>
            <p class="text-muted">Sé el primero en dejar una reseña.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
</div>

<!-- MODAL EDITAR PRODUCTO -->
{% if is_owner %}
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Editar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="editProductForm">
          <input type="hidden" name="product_id" id="editProductId">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre</label>
            <input type="text" class="form-control" name="name" id="editProductName" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Descripción</label>
            <textarea class="form-control" name="description" id="editProductDescription" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Precio (Bs.)</label>
            <input type="number" class="form-control" name="price" id="editProductPrice" step="0.01" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Stock Disponible</label>
            <input type="number" class="form-control" name="stock" id="editProductStock" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Nueva Imagen (opcional)</label>
            <input type="file" class="form-control" name="image" accept="image/*">
          </div>
          <button type="submit" class="btn btn-primary w-100">Guardar Cambios</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL AGREGAR PRODUCTO -->
{% if is_owner %}
<div class="modal fade" id="addProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Agregar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addProductForm">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre</label>
            <input type="text" class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Precio (Bs.)</label>
            <input type="number" class="form-control" name="price" step="0.01" min="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Stock Inicial</label>
            <input type="number" class="form-control" name="stock" min="0" value="0" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Imagen</label>
            <input type="file" class="form-control" name="image" accept="image/*">
          </div>
          <button type="submit" class="btn btn-primary w-100">Agregar</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL RESERVAR PRODUCTO -->
{% if session.user_id and not is_owner %}
<div class="modal fade" id="reserveProductModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Reservar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="reserveProductForm">
          <input type="hidden" name="product_id" id="reserveProductId">
          <h6 class="fw-bold" id="reserveProductName"></h6>
          <p class="text-muted">Stock disponible: <span id="reserveProductStock"></span></p>
          <div class="mb-3">
            <label class="form-label fw-bold">Cantidad a reservar</label>
            <input type="number" class="form-control" name="quantity" id="reserveProductQuantity" min="1" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Notas para el vendedor (opcional)</label>
            <textarea class="form-control" name="notes" rows="2" placeholder="Ej: 'Pasaré a recogerlo mañana por la tarde'"></textarea>
          </div>
          <button type="submit" class="btn btn-primary w-100">Confirmar Reserva</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL ACTUALIZAR LOGO -->
{% if is_owner %}
<div class="modal fade" id="updateLogoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Actualizar Logo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form id="updateLogoForm" method="POST" action="{{ url_for('update_logo', id=business.id) }}" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label fw-bold">Selecciona la nueva imagen</label>
            <input type="file" class="form-control" name="logo" accept="image/*" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Actualizar Logo</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- MODAL EDITAR NEGOCIO -->
{% if is_owner %}
<div class="modal fade" id="editBusinessModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title">Editar Información del Negocio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <form method="POST" action="{{ url_for('edit_business', id=business.id) }}">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre del Negocio</label>
            <input type="text" class="form-control" name="name" value="{{ business.name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Descripción</label>
            <textarea class="form-control" name="description" rows="5" required>{{ business.description }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Categoría</label>
            <select name="category" class="form-select" required>
              {% set categories = ["Gastronomía", "Moda y Ropa", "Servicios Profesionales", "Belleza y Cuidado Personal", "Hogar y Decoración", "Tecnología", "Salud y Bienestar", "Educación", "Otros"] %}
              {% for cat in categories %}
              <option value="{{ cat }}" {% if business.category == cat %}selected{% endif %}>{{ cat }}</option>
              {% endfor %}
            </select>
          </div>
          <hr class="my-4">
          <h6 class="mb-3">Información de Contacto (Opcional)</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold"><i class="bi bi-telephone"></i> Teléfono</label>
              <input type="tel" class="form-control" name="phone" value="{{ business.phone or '' }}">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold"><i class="bi bi-whatsapp text-success"></i> WhatsApp</label>
              <input type="tel" class="form-control" name="whatsapp" value="{{ business.whatsapp or '' }}" placeholder="591xxxxxxxx">
            </div>
            <div class="col-md-12">
              <label class="form-label fw-bold"><i class="bi bi-envelope"></i> Email del Negocio</label>
              <input type="email" class="form-control" name="business_email" value="{{ business.email or '' }}">
            </div>
          </div>
          <hr class="my-4">
          <h6 class="mb-3">Ubicación en el Mapa</h6>
          <p class="text-muted small">Haz clic en el mapa para colocar o mover el marcador en la ubicación exacta de tu negocio.</p>
          <div id="editMap" style="height: 300px; border-radius: 12px; z-index: 1056;"></div>
          <input type="hidden" id="latitude" name="latitude" value="{{ business.latitude or '' }}">
          <input type="hidden" id="longitude" name="longitude" value="{{ business.longitude or '' }}">
          <button type="button" id="clearLocationBtn" class="btn btn-sm btn-outline-danger mt-2">
            <i class="bi bi-x-circle"></i> Limpiar Ubicación
          </button>

          <button type="submit" class="btn btn-primary w-100 mt-4">Guardar Cambios</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>
  // --- CORRECCIÓN: Leer datos desde el contenedor correcto ---
  const profileContainer = document.querySelector('[data-business-id]');
  const businessId = profileContainer.dataset.businessId;
  const isOwner = profileContainer.dataset.isOwner === 'true';

  // --- FIX: Evitar que la tarjeta se voltee con el mouse ---
  // El CSS original probablemente tiene un :hover que causa el flip.
  // Con JS, añadimos y quitamos una clase 'hover-effect' para controlar esto
  // y asegurarnos de que solo se voltee al hacer clic en el botón de detalles.
  document.querySelectorAll('.product-card-new').forEach(card => {
    card.addEventListener('mouseenter', () => card.classList.add('hover-effect'));
    card.addEventListener('mouseleave', () => card.classList.remove('hover-effect'));
  });

  // --- LÓGICA DE FLIP CARD MEJORADA ---
  document.querySelectorAll('.product-card-new').forEach(card => {
    // Voltear la tarjeta al hacer clic en ella
    card.addEventListener('click', (e) => {
      // Evitar que la tarjeta se voltee si se hace clic en un botón (ej. Reservar)
      if (e.target.closest('button, a')) {
        return;
      }
      card.classList.toggle('flipped');
    });
  });
  
  // Voltear la tarjeta de vuelta al hacer clic en el botón "Volver" del reverso
  document.querySelectorAll('.flip-back-button').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation(); // Detener la propagación para no volver a activar el flip del padre
      e.target.closest('.product-card-new').classList.remove('flipped');
    });
  });

  // --- LÓGICA DE RESERVAS (CLIENTE) ---
  document.querySelectorAll('.reserve-product').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const data = e.currentTarget.dataset;
      document.getElementById('reserveProductId').value = data.id;
      document.getElementById('reserveProductName').textContent = data.name;
      const stockSpan = document.getElementById('reserveProductStock');
      stockSpan.textContent = data.stock;
      const quantityInput = document.getElementById('reserveProductQuantity');
      quantityInput.max = data.stock;
      quantityInput.value = 1;
    });
  });

  const reserveForm = document.getElementById('reserveProductForm');
  reserveForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(reserveForm);
    const data = Object.fromEntries(formData.entries());

    try {
      const resp = await fetch('/api/reservations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await resp.json();
      if (result.success) {
        alert(result.message + ' El vendedor se pondrá en contacto contigo.');
        location.reload();
      } else {
        alert('Error: ' + (result.error || 'No se pudo crear la reserva.'));
      }
    } catch (err) {
      alert('Error de conexión al intentar reservar.');
    }
  });

  // --- LÓGICA DE GESTIÓN DE RESERVAS (DUEÑO) ---
  document.querySelectorAll('.update-status').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const button = e.currentTarget;
      const reservationId = button.closest('tr').dataset.reservationId;
      const newStatus = button.dataset.status;

      if (!confirm(`¿Seguro que quieres cambiar el estado de esta reserva a "${newStatus}"?`)) return;

      try {
        const resp = await fetch(`/api/reservations/${reservationId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        const result = await resp.json();
        if (result.success) {
          location.reload();
        } else {
          alert('Error: ' + (result.error || 'No se pudo actualizar el estado.'));
        }
      } catch (err) { alert('Error de conexión.'); }
    });
  });

  // Solo inicializamos el formulario y el modal si el usuario es propietario
  if (isOwner) {
    const form = document.getElementById('addProductForm');
    const modalEl = document.getElementById('addProductModal');
    const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const resp = await fetch(`/api/products/${businessId}`, {
          method: 'POST',
          body: formData
        });
        const data = await resp.json();
        if (data.success) {
          form.reset();
          modal?.hide();
          location.reload();
        } else {
          alert('Error: ' + (data.error || 'No se pudo agregar'));
        }
      } catch (err) {
        alert('Error de conexión');
      }
    });
  }

  // --- LÓGICA DE FAVORITOS ---
  const favoriteBtn = document.getElementById('favoriteBtn');
  if (favoriteBtn) {
    favoriteBtn.addEventListener('click', async () => {
      try {
        const resp = await fetch(`/api/business/${businessId}/favorite`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await resp.json();
        if (result.success) {
          const icon = favoriteBtn.querySelector('i');
          if (result.favorited) {
            icon.classList.add('bi-heart-fill', 'text-danger', 'animate-heartbeat');
            icon.classList.remove('bi-heart');
          } else {
            icon.classList.add('bi-heart');
            icon.classList.remove('bi-heart-fill');
          }
          // Remove animation class after it plays
          icon.addEventListener('animationend', () => icon.classList.remove('animate-heartbeat'));
        }
      } catch (err) {
        alert('Error de conexión. No se pudo cambiar el estado de favorito.');
      }
    });
  }

  // Manejadores de edición de producto
  document.querySelectorAll('.edit-product').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const data = e.target.closest('.edit-product').dataset;
      document.getElementById('editProductId').value = data.id;
      document.getElementById('editProductName').value = data.name;
      document.getElementById('editProductDescription').value = data.description;
      document.getElementById('editProductPrice').value = data.price;
      document.getElementById('editProductStock').value = data.stock;
    });
  });

  const editProductForm = document.getElementById('editProductForm');
  editProductForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const productId = formData.get('product_id');

    try {
      const resp = await fetch(`/api/products/${productId}`, {
        method: 'PUT',
        body: formData
      });
      const data = await resp.json();
      if (data.success) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
        modal.hide();
        location.reload();
      } else {
        alert('Error: ' + (data.error || 'No se pudo actualizar el producto'));
      }
    } catch (err) {
      alert('Error de conexión');
    }
  });

  async function deleteProduct(btn) {
    const id = btn.closest('.delete-product').dataset.id;
    if (!confirm('¿Eliminar este producto?')) return;

    try {
      const resp = await fetch(`/api/products/${id}`, { method: 'DELETE' });
      const data = await resp.json();
      if (data.success) {
        btn.closest('.col-lg-3, .col-md-4, .col-6').remove();
        if (document.getElementById('products-list').children.length === 0) {
          location.reload();
        }
      } else {
        alert('Error: ' + (data.error || 'No se pudo eliminar'));
      }
    } catch (err) {
      alert('Error de conexión');
    }
  }

  // --- MAPA LEAFLET ---
  const lat = profileContainer.dataset.latitude ? parseFloat(profileContainer.dataset.latitude) : null;
  const lon = profileContainer.dataset.longitude ? parseFloat(profileContainer.dataset.longitude) : null;
  const defaultLat = -17.7833; // Santa Cruz
  const defaultLon = -63.1833;

  const profileMapDiv = document.getElementById('profileMap');
  if (profileMapDiv) {
    const map = L.map('profileMap');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    if (lat && lon) {
      map.setView([lat, lon], 16);
      L.marker([lat, lon]).addTo(map).bindPopup('<b>{{ business.name }}</b><br>Ubicación exacta.').openPopup();
    } else {
      map.setView([defaultLat, defaultLon], 12);
    }
  }

  // Mapa en el modal de edición (interactivo)
  const editBusinessModal = document.getElementById('editBusinessModal');
  editBusinessModal?.addEventListener('shown.bs.modal', () => {
    const editMap = L.map('editMap').setView([lat || defaultLat, lon || defaultLon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(editMap);

    let marker;
    const latInput = document.getElementById('latitude');
    const lonInput = document.getElementById('longitude');

    if (lat && lon) {
      marker = L.marker([lat, lon], { draggable: true }).addTo(editMap);
    }

    editMap.on('click', (e) => {
      const { lat, lng } = e.latlng;
      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng, { draggable: true }).addTo(editMap);
      }
      latInput.value = lat;
      lonInput.value = lng;

      marker.on('dragend', (event) => {
        const position = marker.getLatLng();
        latInput.value = position.lat;
        lonInput.value = position.lng;
      });
    });

    if (marker) {
      marker.on('dragend', (event) => {
        const position = marker.getLatLng();
        latInput.value = position.lat;
        lonInput.value = position.lng;
      });
    }

    document.getElementById('clearLocationBtn').addEventListener('click', () => {
      if (marker) editMap.removeLayer(marker);
      latInput.value = '';
      lonInput.value = '';
    });
  });
  // --- LÓGICA DE RESEÑAS ---
  const reviewForm = document.getElementById('reviewForm');
  if (reviewForm) {
    const ratingStars = document.getElementById('ratingStars');
    const ratingInput = document.getElementById('ratingInput');

    ratingStars.addEventListener('click', (e) => {
      if (e.target.tagName === 'I') {
        const rating = e.target.dataset.value;
        ratingInput.value = rating;
        // Actualizar visualmente las estrellas
        Array.from(ratingStars.children).forEach(star => {
          if (star.dataset.value <= rating) {
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill');
          } else {
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
          }
        });
      }
    });

    reviewForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(reviewForm);
      const data = Object.fromEntries(formData.entries());

      try {
        const resp = await fetch(`/api/reviews/${businessId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await resp.json();
        if (result.success) {
          location.reload(); // Recargar solo si la reseña se envió con éxito
        } else {
          alert('Error: ' + (result.error || 'No se pudo enviar la reseña.'));
        }
      } catch (err) {
        alert('Error de conexión al enviar la reseña.');
      }
    });
  }
</script>
{% endblock %}
